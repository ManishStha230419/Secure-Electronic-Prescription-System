{% extends "base.html" %}
{% block title %}Admin - Algorithm Usage Log{% endblock %}
{% block content %}
<div class="row">
  <div class="col-md-3 mb-4">
    <div class="card">
      <div class="card-header bg-info text-white">
        <h6 class="mb-0"><i class="bi bi-cpu"></i> Algorithm Statistics</h6>
      </div>
      <div class="card-body">
        <h6 class="text-muted mb-2">Usage Count:</h6>
        {% for algo, count in algo_stats %}
        <div class="d-flex justify-content-between mb-2">
          <span class="small"><strong>{{ algo }}</strong></span>
          <span class="badge bg-primary">{{ count }}</span>
        </div>
        {% else %}
        <p class="text-muted small">No data yet</p>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="col-md-9 mb-4">
    <div class="card">
      <div class="card-header bg-success text-white">
        <h3 class="mb-0"><i class="bi bi-shield-lock"></i> Cryptographic Algorithm Usage Log</h3>
        <p class="mb-0 small">Every time an algorithm is used, it's logged here with full parameters</p>
      </div>
      <div class="card-body">
        <div class="alert alert-success">
          <i class="bi bi-info-circle"></i> <strong>This shows:</strong> Which algorithm was used, when, for what purpose, with what parameters
        </div>

        <form method="GET" class="row g-2 mb-3">
          <div class="col-md-3">
            <select name="algorithm" class="form-select">
              <option value="">All Algorithms</option>
              <option value="RSA-2048" {% if algo_filter=='RSA-2048' %}selected{% endif %}>RSA-2048</option>
              <option value="AES-256-GCM" {% if algo_filter=='AES-256-GCM' %}selected{% endif %}>AES-256-GCM</option>
              <option value="RSA-PSS" {% if algo_filter=='RSA-PSS' %}selected{% endif %}>RSA-PSS</option>
              <option value="SHA-256" {% if algo_filter=='SHA-256' %}selected{% endif %}>SHA-256</option>
              <option value="RSA-OAEP" {% if algo_filter=='RSA-OAEP' %}selected{% endif %}>RSA-OAEP</option>
              <option value="PBKDF2-SHA256" {% if algo_filter=='PBKDF2-SHA256' %}selected{% endif %}>PBKDF2-SHA256</option>
              <option value="MGF1-SHA256" {% if algo_filter=='MGF1-SHA256' %}selected{% endif %}>MGF1-SHA256</option>
            </select>
          </div>
          <div class="col-md-3">
            <select name="operation" class="form-select">
              <option value="">All Operations</option>
              <option value="password_save" {% if operation_filter=='password_save' %}selected{% endif %}>Password Save</option>
              <option value="prescription_encrypt" {% if operation_filter=='prescription_encrypt' %}selected{% endif %}>Prescription Encrypt</option>
              <option value="prescription_decrypt" {% if operation_filter=='prescription_decrypt' %}selected{% endif %}>Prescription Decrypt</option>
            </select>
          </div>
          <div class="col-md-2"><button type="submit" class="btn btn-primary w-100"><i class="bi bi-funnel"></i> Filter</button></div>
          <div class="col-md-2"><a href="{{ url_for('admin_algorithm_usage') }}" class="btn btn-outline-secondary w-100">Clear</a></div>
          <div class="col-md-2"><a href="{{ url_for('download_report') }}" class="btn btn-success w-100"><i class="bi bi-download"></i> Report</a></div>
        </form>

        <div class="table-responsive">
          <table class="table table-sm table-hover">
            <thead class="table-success">
              <tr>
                <th>Timestamp</th>
                <th>Algorithm</th>
                <th>Process Type</th>
                <th>Step</th>
                <th>Description</th>
                <th>Resource</th>
                <th>User</th>
                <th>Parameters</th>
              </tr>
            </thead>
            <tbody>
              {% for log in logs.items %}
              <tr>
                <td><small>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</small></td>
                <td><span class="badge bg-primary">{{ log.algorithm_used or '-' }}</span></td>
                <td>
                  <span class="badge bg-{% if log.process_type=='password_save' %}danger{% elif log.process_type=='prescription_encrypt' %}success{% else %}info{% endif %}">
                    {{ log.process_type.replace('_',' ').title() if log.process_type else '-' }}
                  </span>
                </td>
                <td><strong>Step {{ log.step_number }}</strong></td>
                <td><small>{{ log.step_description[:60] }}{% if log.step_description and log.step_description|length > 60 %}...{% endif %}</small></td>
                <td><code class="small">{{ log.resource_id if log.resource_id else '-' }}</code></td>
                <td><small>{{ log.user.username if log.user else 'System' }}</small></td>
                <td>
                  {% if log.parameters %}
                    {% set params = log.parameters|from_json %}
                    <small>
                    {% for key, val in params.items() %}
                      <strong>{{ key }}:</strong> {{ val }}<br>
                    {% endfor %}
                    </small>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
              </tr>
              {% else %}
              <tr><td colspan="8" class="text-center text-muted py-4">No algorithm usage logs found</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <nav>
          <ul class="pagination justify-content-center">
            {% if logs.has_prev %}<li class="page-item"><a class="page-link" href="?page={{ logs.prev_num }}&algorithm={{ algo_filter }}&operation={{ operation_filter }}">Previous</a></li>{% endif %}
            <li class="page-item disabled"><span class="page-link">Page {{ logs.page }} of {{ logs.pages }}</span></li>
            {% if logs.has_next %}<li class="page-item"><a class="page-link" href="?page={{ logs.next_num }}&algorithm={{ algo_filter }}&operation={{ operation_filter }}">Next</a></li>{% endif %}
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>
{% endblock %}
