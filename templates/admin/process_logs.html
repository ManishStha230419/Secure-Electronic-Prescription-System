{% extends "base.html" %}
{% block title %}Admin - Complete Process Logs{% endblock %}
{% block content %}
<div class="card">
  <div class="card-header bg-success text-white">
    <h3 class="mb-0"><i class="bi bi-gear-fill"></i> Complete Process Logs</h3>
    <p class="mb-0 small">Shows EVERY STEP of how passwords are saved & prescriptions are encrypted</p>
  </div>
  <div class="card-body">
    <div class="alert alert-success">
      <strong><i class="bi bi-info-circle"></i> This shows:</strong>
      <ul class="mb-0">
        <li><strong>Password Save Process:</strong> 5 steps - Salt generation ‚Üí PBKDF2 ‚Üí Key derivation ‚Üí Formatting ‚Üí Database storage</li>
        <li><strong>Prescription Encryption:</strong> 9 steps - AES key gen ‚Üí Nonce ‚Üí JSON ‚Üí AES encrypt ‚Üí RSA key load ‚Üí Key wrap ‚Üí Hash ‚Üí Sign ‚Üí Store</li>
        <li><strong>Prescription Decryption:</strong> 5 steps - Load key ‚Üí Unwrap ‚Üí Decrypt ‚Üí Parse ‚Üí Verify signature</li>
      </ul>
    </div>

    <form method="GET" class="row g-2 mb-3">
      <div class="col-md-3">
        <select name="process" class="form-select">
          <option value="">All Processes</option>
          {% for p in all_processes %}
          <option value="{{ p }}" {% if process_filter==p %}selected{% endif %}>
            {% if p == 'password_save' %}Password Save (5 steps)
            {% elif p == 'prescription_encrypt' %}Prescription Encrypt (9 steps)
            {% elif p == 'prescription_decrypt' %}Prescription Decrypt (5 steps)
            {% else %}{{ p }}{% endif %}
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <input type="text" name="resource" class="form-control" placeholder="Username or RX-ID" value="{{ resource_filter }}">
      </div>
      <div class="col-md-2"><button type="submit" class="btn btn-primary w-100"><i class="bi bi-funnel"></i> Filter</button></div>
      <div class="col-md-2"><a href="{{ url_for('audit_log') }}" class="btn btn-outline-secondary w-100">Clear</a></div>
      <div class="col-md-2"><a href="{{ url_for('download_process_report') }}" class="btn btn-success w-100"><i class="bi bi-download"></i> Download</a></div>
    </form>

    <div class="table-responsive">
      <table class="table table-sm table-bordered">
        <thead class="table-success">
          <tr>
            <th>Resource</th>
            <th>Process</th>
            <th>Step</th>
            <th>Description</th>
            <th>Algorithm</th>
            <th>Input</th>
            <th>Output</th>
            <th>Parameters</th>
          </tr>
        </thead>
        <tbody>
          {% set current_resource = '' %}
          {% for log in logs.items %}
            {% if log.resource_id != current_resource %}
              {% set current_resource = log.resource_id %}
              <tr class="table-warning">
                <td colspan="8">
                  <strong>
                    {% if log.process_type == 'password_save' %}
                      üîê PASSWORD SAVE PROCESS: {{ log.resource_id }}
                    {% elif log.process_type == 'prescription_encrypt' %}
                      üìã PRESCRIPTION ENCRYPTION PROCESS: {{ log.resource_id }}
                    {% elif log.process_type == 'prescription_decrypt' %}
                      üîì PRESCRIPTION DECRYPTION PROCESS: {{ log.resource_id }}
                    {% endif %}
                  </strong>
                  <small class="float-end">{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                </td>
              </tr>
            {% endif %}
            <tr>
              <td><small>{{ log.resource_id }}</small></td>
              <td>
                <span class="badge bg-{% if log.process_type=='password_save' %}danger{% elif log.process_type=='prescription_encrypt' %}success{% else %}info{% endif %}">
                  {{ log.process_type.replace('_', ' ').title() }}
                </span>
              </td>
              <td><strong class="text-primary">Step {{ log.step_number }}</strong></td>
              <td><small>{{ log.step_description }}</small></td>
              <td><span class="badge bg-secondary">{{ log.algorithm_used }}</span></td>
              <td><code class="small">{{ log.input_data[:50] }}{% if log.input_data|length > 50 %}...{% endif %}</code></td>
              <td><code class="small">{{ log.output_data[:50] }}{% if log.output_data|length > 50 %}...{% endif %}</code></td>
              <td>
                {% if log.parameters %}
                  {% set params = log.parameters|from_json %}
                  <small>
                  {% for key, val in params.items() %}
                    <strong>{{ key }}:</strong> {{ val }}<br>
                  {% endfor %}
                  </small>
                {% else %}
                  -
                {% endif %}
              </td>
            </tr>
          {% else %}
          <tr><td colspan="8" class="text-center text-muted py-4">No process logs found</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <nav>
      <ul class="pagination justify-content-center">
        {% if logs.has_prev %}<li class="page-item"><a class="page-link" href="?page={{ logs.prev_num }}&process={{ process_filter }}&resource={{ resource_filter }}">Previous</a></li>{% endif %}
        <li class="page-item disabled"><span class="page-link">Page {{ logs.page }} of {{ logs.pages }}</span></li>
        {% if logs.has_next %}<li class="page-item"><a class="page-link" href="?page={{ logs.next_num }}&process={{ process_filter }}&resource={{ resource_filter }}">Next</a></li>{% endif %}
      </ul>
    </nav>
  </div>
</div>
{% endblock %}
