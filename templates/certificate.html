{% extends "base.html" %}
{% block title %}Certificate - {{ cert_user.username }}{% endblock %}
{% block content %}
<div class="card">
    <div class="card-header bg-success text-white">
        <h4 class="mb-0"><i class="bi bi-patch-check"></i> X.509 Digital Certificate â€” {{ cert_user.full_name }}</h4>
        <small>PKI Certificate Management | Certificate-Based Authentication</small>
    </div>
    <div class="card-body">
        {% if cert_user.key_revoked %}
        <div class="alert alert-danger"><i class="bi bi-x-circle"></i> <strong>REVOKED:</strong> This certificate has been revoked at {{ cert_user.key_revoked_at.strftime('%Y-%m-%d %H:%M') if cert_user.key_revoked_at }}.</div>
        {% endif %}

        {% if validity %}
        <div class="alert alert-{{ 'success' if validity.valid else 'danger' }}">
            <i class="bi bi-{{ 'check-circle' if validity.valid else 'x-circle' }}"></i>
            <strong>Validation Result:</strong> {{ validity.message }}
        </div>
        {% endif %}

        {% if cert_info and not cert_info.get('error') %}
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white"><h6 class="mb-0"><i class="bi bi-person"></i> Subject Information</h6></div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr><th>Common Name (CN)</th><td><code>{{ cert_info.cn }}</code></td></tr>
                            <tr><th>Organization</th><td>{{ cert_info.org }}</td></tr>
                            <tr><th>Role</th><td><span class="badge bg-info">{{ cert_user.role }}</span></td></tr>
                            <tr><th>Serial Number</th><td><code class="small">{{ cert_info.serial }}</code></td></tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-info text-white"><h6 class="mb-0"><i class="bi bi-calendar"></i> Validity Period</h6></div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr><th>Valid From</th><td>{{ cert_info.not_before }}</td></tr>
                            <tr><th>Valid Until</th><td>{{ cert_info.not_after }}</td></tr>
                            <tr><th>Status</th><td><span class="badge bg-{{ 'danger' if cert_info.expired else 'success' }}">{{ 'EXPIRED' if cert_info.expired else 'VALID' }}</span></td></tr>
                            <tr><th>Key Algorithm</th><td><span class="badge bg-primary">RSA-2048</span></td></tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="card mb-3">
            <div class="card-header bg-secondary text-white"><h6 class="mb-0"><i class="bi bi-shield-lock"></i> Certificate Extensions</h6></div>
            <div class="card-body">
                <span class="badge bg-success me-2">Digital Signature</span>
                <span class="badge bg-success me-2">Content Commitment (Non-repudiation)</span>
                <span class="badge bg-success me-2">Key Encipherment</span>
                <span class="badge bg-warning text-dark me-2">Basic Constraints: CA=False</span>
            </div>
        </div>
        <div class="card mb-3">
            <div class="card-header bg-dark text-white"><h6 class="mb-0"><i class="bi bi-file-code"></i> PEM Certificate</h6></div>
            <div class="card-body">
                <pre class="bg-light p-3 small" style="max-height:200px;overflow-y:auto;">{{ cert_user.certificate_pem }}</pre>
            </div>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('download_certificate', username=cert_user.username) }}" class="btn btn-success">
                <i class="bi bi-download"></i> Download PEM Certificate
            </a>
            {% if session.get('role') in ['admin', 'doctor'] and not cert_user.key_revoked %}
            <a href="{{ url_for('revoke_key') }}" class="btn btn-danger">
                <i class="bi bi-x-circle"></i> Revoke This Certificate
            </a>
            {% endif %}
        </div>
        {% else %}
        <div class="alert alert-warning">No certificate generated yet.</div>
        {% endif %}
    </div>
</div>
{% endblock %}
